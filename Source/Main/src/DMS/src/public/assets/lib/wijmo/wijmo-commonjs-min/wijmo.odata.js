/*!
    *
    * Wijmo Library 5.20201.680
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var wijmo_1=require("wijmo/wijmo"),selfModule=require("wijmo/wijmo.odata");function softGrid(){return wijmo_1._getModule("wijmo.grid")}exports.softGrid=softGrid;function softFilter(){return wijmo_1._getModule("wijmo.grid.filter")}exports.softFilter=softFilter;var ODataCollectionView=function(e){__extends(ODataCollectionView,e);function ODataCollectionView(t,i,o){var n=e.call(this)||this;n._count=0;n._sortOnServer=!0;n._pageOnServer=!0;n._filterOnServer=!0;n._deferCommits=!1;n._hasPendingChanges=!1;n._showDatesAsGmt=!1;n._inferDataTypes=!0;n._reviverBnd=n._reviver.bind(n);n.loading=new wijmo_1.Event;n.loaded=new wijmo_1.Event;n.error=new wijmo_1.Event;n.hasPendingChangesChanged=new wijmo_1.Event;n._url=wijmo_1.asString(t,!1);n._tbl=wijmo_1.asString(i);o&&wijmo_1.copy(n,o);n.sortDescriptions.collectionChanged.addHandler((function(){n.sortOnServer&&!n.hasPendingChanges&&n._getData()}));n.itemsEdited.collectionChanged.addHandler(n._updateHasChanges,n);n.itemsAdded.collectionChanged.addHandler(n._updateHasChanges,n);n.itemsRemoved.collectionChanged.addHandler(n._updateHasChanges,n);n._getData();return n}Object.defineProperty(ODataCollectionView.prototype,"tableName",{get:function(){return this._tbl},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"entityType",{get:function(){return this._entityType},set:function(e){this._entityType=wijmo_1.asString(e)},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"fields",{get:function(){return this._fields},set:function(e){if(this._fields!=e){this._fields=wijmo_1.asArray(e);this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"requestHeaders",{get:function(){return this._requestHeaders},set:function(e){this._requestHeaders=e},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"keys",{get:function(){return this._keys},set:function(e){this._keys=wijmo_1.asArray(e)},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"expand",{get:function(){return this._expand},set:function(e){this._expand=wijmo_1.asString(e)},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"jsonReviver",{get:function(){return this._jsonReviver},set:function(e){this._jsonReviver=wijmo_1.asFunction(e)},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"dataTypes",{get:function(){return this._dataTypes},set:function(e){this._dataTypes=e},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"inferDataTypes",{get:function(){return this._inferDataTypes},set:function(e){if(e!=this.inferDataTypes){this._inferDataTypes=wijmo_1.asBoolean(e);this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"showDatesAsGmt",{get:function(){return this._showDatesAsGmt},set:function(e){if(e!=this.showDatesAsGmt){this._showDatesAsGmt=wijmo_1.asBoolean(e);this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"sortOnServer",{get:function(){return this._sortOnServer},set:function(e){if(e!=this._sortOnServer){this._sortOnServer=wijmo_1.asBoolean(e);this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"pageOnServer",{get:function(){return this._pageOnServer},set:function(e){if(e!=this._pageOnServer){this._pageOnServer=wijmo_1.asBoolean(e);this.pageSize&&this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"filterOnServer",{get:function(){return this._filterOnServer},set:function(e){if(e!=this._filterOnServer){this._filterOnServer=wijmo_1.asBoolean(e);this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"filterDefinition",{get:function(){return this._filterDef},set:function(e){if(e!=this._filterDef){this._filterDef=wijmo_1.asString(e);this._getData()}},enumerable:!0,configurable:!0});ODataCollectionView.prototype.updateFilterDefinition=function(e){this.filterOnServer&&softGrid()&&softFilter()&&e instanceof softFilter().FlexGridFilter&&(this.filterDefinition=this._asODataFilter(e))};Object.defineProperty(ODataCollectionView.prototype,"oDataVersion",{get:function(){return this._odv},set:function(e){this._odv=wijmo_1.asNumber(e)},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"deferCommits",{get:function(){return this._deferCommits},set:function(e){this._deferCommits=wijmo_1.asBoolean(e);this.deferCommits&&(this.trackChanges=!0)},enumerable:!0,configurable:!0});ODataCollectionView.prototype.onLoading=function(e){this.loading.raise(this,e)};ODataCollectionView.prototype.onLoaded=function(e){this.loaded.raise(this,e)};ODataCollectionView.prototype.load=function(){this._getData()};ODataCollectionView.prototype.onError=function(e){this.error.raise(this,e);return!e.cancel};ODataCollectionView.prototype.onHasPendingChangesChanged=function(e){this.hasPendingChangesChanged.raise(this,e)};ODataCollectionView.prototype.implementsInterface=function(t){return"IEditableCollectionView"==t?null!=this.keys&&this.keys.length>0:e.prototype.implementsInterface.call(this,t)};ODataCollectionView.prototype.commitNew=function(){var t=this;if(!this.deferCommits){var i={Accept:"application/json"};if(this.requestHeaders)for(var o in this.requestHeaders)i[o]=this.requestHeaders[o];var n=this.currentAddItem;if(n){var r=this._getWriteUrl();wijmo_1.httpRequest(r,{method:"POST",requestHeaders:i,data:this._convertToDbFormat(n),success:function(e){var i=JSON.parse(e.responseText,t._reviverBnd);t.keys.forEach((function(e){n[e]=i[e]}));t.refresh()},error:this._error.bind(this)})}}e.prototype.commitNew.call(this)};ODataCollectionView.prototype.commitEdit=function(){if(!this.deferCommits){var t=this.currentEditItem;if(t&&!this.currentAddItem&&this._getChangedFields(t,this._edtClone)){var i=this._getWriteUrl(this._edtClone);wijmo_1.httpRequest(i,{method:"PATCH",requestHeaders:this.requestHeaders,data:this._convertToDbFormat(t),error:this._error.bind(this)})}}e.prototype.commitEdit.call(this)};ODataCollectionView.prototype.remove=function(t){if(!this.deferCommits&&t&&t!=this.currentAddItem&&this.items.indexOf(t)>-1){var i=this._getWriteUrl(t);wijmo_1.httpRequest(i,{method:"DELETE",requestHeaders:this.requestHeaders,error:this._error.bind(this)})}e.prototype.remove.call(this,t)};ODataCollectionView.prototype.commitChanges=function(e){var t=this;if(this.deferCommits){var i=[];this.itemsEdited.forEach((function(e){i.push({method:"PATCH",url:t._getWriteUrl(e),data:t._convertToDbFormat(e)})}));this.itemsAdded.forEach((function(e){i.push({method:"POST",url:t._getWriteUrl(),data:t._convertToDbFormat(e)})}));this.itemsRemoved.forEach((function(e){i.push({method:"DELETE",url:t._getWriteUrl(e)})}));if(i.length){var o=(new Date).getTime().toString();wijmo_1.httpRequest(this._getServiceUrl()+"$batch",{method:"POST",requestHeaders:{"Content-Type":'multipart/mixed; boundary="'+o+'"'},data:this._encodeBatch(i,o),success:function(e){t.clearChanges();t.load()},error:function(e){if(t.onError(new wijmo_1.RequestErrorEventArgs(e)))throw"HttpRequest Error: "+e.status+" "+e.statusText},complete:function(t){wijmo_1.isFunction(e)&&e(t)}})}}};ODataCollectionView.prototype.cancelChanges=function(){if(this.deferCommits){this.clearChanges();this.load()}};Object.defineProperty(ODataCollectionView.prototype,"hasPendingChanges",{get:function(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"totalItemCount",{get:function(){return this._count},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"pageCount",{get:function(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1},enumerable:!0,configurable:!0});Object.defineProperty(ODataCollectionView.prototype,"pageSize",{get:function(){return this._pgSz},set:function(e){if(e!=this._pgSz){this._pgSz=wijmo_1.asInt(e);if(this.pageOnServer){this._pgIdx=wijmo_1.clamp(this._pgIdx,0,this.pageCount-1);this._getData()}else this.refresh()}},enumerable:!0,configurable:!0});ODataCollectionView.prototype.onPageChanging=function(t){e.prototype.onPageChanging.call(this,t);!t.cancel&&this.pageOnServer&&this._getData();return!t.cancel};ODataCollectionView.prototype._getPageView=function(){return this.pageOnServer?this._view:e.prototype._getPageView.call(this)};ODataCollectionView.prototype._performRefresh=function(){var t=this._canFilter,i=this._canSort;this._canFilter=!this._filterOnServer;this._canSort=!this._sortOnServer;e.prototype._performRefresh.call(this);this._canFilter=t;this._canSort=i};ODataCollectionView.prototype._updateHasChanges=function(){var e=this.hasPendingChanges;if(e!=this._hasPendingChanges){this._hasPendingChanges=e;this.onHasPendingChangesChanged()}};ODataCollectionView.prototype._storeItems=function(e,t){t?Array.prototype.push.apply(this.sourceCollection,e):this.sourceCollection=e};ODataCollectionView.prototype._getReadUrl=function(e){var t=this._getServiceUrl();e?t=0==e.indexOf("http")?e:t+e:this._tbl&&(t+=this._tbl);return t};ODataCollectionView.prototype._getReadParams=function(e){var t={};(!e||e.indexOf("$format")<0&&e.indexOf("%24format")<0)&&(t.$format="json");if(!e&&this._tbl){this._odv<4?t.$inlinecount="allpages":t.$count=!0;this.fields&&(t.$select=this.fields.join(","));this.expand&&(t.$expand=this.expand);if(this.sortOnServer&&this.sortDescriptions.length){var i="";this.sortDescriptions.forEach((function(e){i&&(i+=",");i+=e.property;e.ascending||(i+=" desc")}));t.$orderby=i}if(this.pageOnServer&&this.pageSize>0){t.$skip=this.pageIndex*this.pageSize;t.$top=this.pageSize}this.filterDefinition&&(t.$filter=this._encodeFilterDefinition())}return t};ODataCollectionView.prototype._encodeFilterDefinition=function(){return this.filterDefinition.replace(/%/g,"%25").replace(/\+/g,"%2B").replace(/\//g,"%2F").replace(/\?/g,"%3F").replace(/#/g,"%23").replace(/&/g,"%26")};ODataCollectionView.prototype._getData=function(e,t){var i=this;this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout((function(){if(null!=i._odv){i._loading=!0;i.onLoading();var o=wijmo_1.httpRequest(i._getReadUrl(e),{requestHeaders:i.requestHeaders,data:i._getReadParams(e),success:function(t){var o=JSON.parse(t.responseText,i._reviverBnd),n=o.d?o.d.results:o.value,r=o.d?o.d.__count:o["odata.count"]||o["@odata.count"];null!=r&&(i._count=parseInt(r));if(i.pageIndex>0&&i.pageIndex>=i.pageCount){var a=i.pageIndex;i.moveToLastPage();if(i.pageIndex!=a)return}e||i.inferDataTypes&&!i._dataTypesInferred&&(i._dataTypesInferred=i._getInferredDataTypes(n));var s=i.dataTypes?i.dataTypes:i._dataTypesInferred;s&&n.forEach((function(e){i._convertItem(s,e)}));i._storeItems(n,null!=e);i.refresh();if(e=o.d?o.d.__next:o["odata.nextLink"]||o["@odata.nextLink"])i._getData(e);else{i._loading=!1;i.onLoaded()}},error:function(e){i._loading=!1;i.onLoaded();if(i.onError(new wijmo_1.RequestErrorEventArgs(e)))throw"HttpRequest Error: "+e.status+" "+e.statusText}});wijmo_1.isFunction(t)&&t(o)}else i._getSchema()}),100)};ODataCollectionView.prototype._convertToDbFormat=function(e){var t={};for(var i in e){var o=e[i];wijmo_1.isDate(o)&&this._showDatesAsGmt?o=new Date(o.getTime()-6e4*o.getTimezoneOffset()):wijmo_1.isNumber(o)&&this._odv<4&&(o=o.toString());t[i]=o}this.entityType&&(t["odata.type"]=this.entityType);return t};ODataCollectionView.prototype._reviver=function(e,t){if("string"==typeof t&&ODataCollectionView._rxDate.test(t)){t=0==t.indexOf("/Date(")?new Date(parseInt(t.substr(6))):new Date(t);wijmo_1.isDate(t)&&this._showDatesAsGmt&&(t=new Date(t.getTime()+6e4*t.getTimezoneOffset()))}return this._jsonReviver?this._jsonReviver(e,t):t};ODataCollectionView.prototype._convertItem=function(e,t){for(var i in e){var o=e[i],n=t[i];if(null!=n){n=o==wijmo_1.DataType.Date&&wijmo_1.isString(n)&&0==n.indexOf("/Date(")?new Date(parseInt(n.substr(6))):wijmo_1.changeType(n,o,null);wijmo_1.isDate(n)&&this._showDatesAsGmt&&(n=new Date(n.getTime()+6e4*n.getTimezoneOffset()));t[i]=n}}};ODataCollectionView.prototype._getInferredDataTypes=function(e){var t=this,i=null;if(e.length>0){var o={};e.forEach((function(e){t._extend(o,e)}));for(var n in o){var r=o[n];if(wijmo_1.isString(r)&&ODataCollectionView._rxDate.test(r)){i||(i={});i[n]=wijmo_1.DataType.Date}}}return i};ODataCollectionView.prototype._getServiceUrl=function(){var e=this._url;"/"!=e[e.length-1]&&(e+="/");return e};ODataCollectionView.prototype._getSchema=function(){var e=this,t=this._getServiceUrl()+"$metadata",i=ODataCollectionView._odvCache;this._odv=i[t];this._odv?this._getData():wijmo_1.httpRequest(t,{requestHeaders:this.requestHeaders,success:function(o){var n=o.responseText.match(/<.*Version\s*=\s*"([0-9.]+)"/),r=n?parseFloat(n[1]):4;i[t]=e._odv=r},error:function(o){i[t]=e._odv=4},complete:function(t){e._getData()}})};ODataCollectionView.prototype._getWriteUrl=function(e){var t=this,i=this._getServiceUrl()+this._tbl;if(e){wijmo_1.assert(this.keys&&this.keys.length>0,"write operations require keys.");var o=[];this.keys.forEach((function(i){var n=e[i];null==n&&(n="");wijmo_1.isString(n)&&(n="'"+n+"'");o.push(1==t.keys.length?n:i+"="+n)}));o.length&&(i+="("+o.join(",")+")")}return i};ODataCollectionView.prototype._asODataFilter=function(e){for(var t="",i=0;i<e.grid.columns.length;i++){var o=e.grid.columns[i],n=e.getColumnFilter(o,!1);if(n&&n.isActive){t&&(t+=" and ");n.conditionFilter&&n.conditionFilter.isActive?t+=this._asODataConditionFilter(n.conditionFilter):n.valueFilter&&n.valueFilter.isActive&&(t+=this._asODataValueFilter(n.valueFilter))}}return t};ODataCollectionView.prototype._asODataValueFilter=function(e){var t=e.column,i=t.binding,o=t.dataMap,n="";for(var r in e.showValues){var a=wijmo_1.changeType(r,t.dataType,t.format);o&&wijmo_1.isString(a)&&(a=o.getKeyValue(a));n&&(n+=" or ");n+=this._asEquals(i,a,t.dataType)}n.length&&(n="("+n+")");return n};ODataCollectionView.prototype._asEquals=function(e,t,i){return i==wijmo_1.DataType.Date?"("+e+" ge "+this._asODataValue(t,i)+" and "+e+" lt "+this._asODataValue(wijmo_1.DateTime.addDays(t,1),i)+")":""==t?"("+e+" eq null or "+e+" eq '')":"("+e+" eq "+this._asODataValue(t,i)+")"};ODataCollectionView.prototype._asODataConditionFilter=function(e){var t=this._asODataCondition(e,e.condition1),i=this._asODataCondition(e,e.condition2);return t&&i?"("+t+(e.and?" and ":" or ")+i+")":t?"("+t+")":i?"("+i+")":null};ODataCollectionView.prototype._asODataCondition=function(e,t){var i=e.column.binding,o=this._asODataValue(t.value,e.column.dataType);switch(t.operator){case 0:return this._asEquals(i,t.value,e.column.dataType);case 1:return i+" ne "+o;case 2:return i+" gt "+o;case 3:return i+" ge "+o;case 4:return i+" lt "+o;case 5:return i+" le "+o;case 6:return"startswith("+i+","+o+")";case 7:return"endswith("+i+","+o+")";case 8:return this._odv>=4?"contains("+i+","+o+")":"substringof("+o.toLowerCase()+", tolower("+i+"))";case 9:return this._odv>=4?"not contains("+i+","+o+")":"not substringof("+o.toLowerCase()+", tolower("+i+"))"}};ODataCollectionView.prototype._asODataValue=function(e,t){if(wijmo_1.isDate(e)){this._showDatesAsGmt&&(e=new Date(e.getTime()-6e4*e.getTimezoneOffset()));e=e.toJSON();this._odv<4&&(e="datetime'"+e.substr(0,10)+"'");return e}return wijmo_1.isString(e)?"'"+e.replace(/'/g,"''")+"'":null!=e?e.toString():t==wijmo_1.DataType.String?"''":null};ODataCollectionView.prototype._error=function(e){if(this.onError(new wijmo_1.RequestErrorEventArgs(e))){this._getData();throw"HttpRequest Error: "+e.status+" "+e.statusText}};ODataCollectionView.prototype._encodeBatch=function(e,t){var i=[],o="changeset-"+t;i.push("--"+t,"Content-Type: multipart/mixed; boundary="+o,"");e.forEach((function(e,t){i.push("--"+o,"Content-Type: application/http","Content-Transfer-Encoding: binary","Content-ID: "+t,"",e.method.toUpperCase()+" "+e.url+" HTTP/1.1","Host: "+location.host);e.data&&i.push("Content-Type: application/json","",JSON.stringify(e.data));i.push("")}));i.push("--"+o+"--","");i.push("--"+t+"--","");return i.join("\r\n")};ODataCollectionView._odvCache={};ODataCollectionView._rxDate=/^\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}|\/Date\([\d\-]*?\)/;return ODataCollectionView}(wijmo_1.CollectionView);exports.ODataCollectionView=ODataCollectionView;var ODataVirtualCollectionView=function(e){__extends(ODataVirtualCollectionView,e);function ODataVirtualCollectionView(t,i,o){var n=this;null==o&&(o={});o.pageOnServer=!0;o.sortOnServer=!0;o.canGroup=!1;o.pageSize||(o.pageSize=100);(n=e.call(this,t,i,o)||this)._data=[];n.sourceCollection=n._data;n._skip=0;n.setWindow(0,n.pageSize);return n}ODataVirtualCollectionView.prototype.setWindow=function(e,t){var i=this;this._toSetWindow&&clearTimeout(this._toSetWindow);this._toSetWindow=setTimeout((function(){i._toSetWindow=null;i._performSetWindow(e,t)}),50)};Object.defineProperty(ODataVirtualCollectionView.prototype,"requestCanceled",{get:function(){this._requestCanceled||(this._requestCanceled=new wijmo_1.Event);return this._requestCanceled},enumerable:!0,configurable:!0});ODataVirtualCollectionView.prototype.onRequestCanceled=function(e){this.requestCanceled.raise(this,e)};Object.defineProperty(ODataVirtualCollectionView.prototype,"pageOnServer",{get:function(){return!0},set:function(e){if(!e)throw"ODataVirtualCollectionView requires pageOnServer = true."},enumerable:!0,configurable:!0});Object.defineProperty(ODataVirtualCollectionView.prototype,"sortOnServer",{get:function(){return!0},set:function(e){if(!wijmo_1.asBoolean(e))throw"ODataVirtualCollectionView requires sortOnServer = true."},enumerable:!0,configurable:!0});Object.defineProperty(ODataVirtualCollectionView.prototype,"filterOnServer",{get:function(){return!0},set:function(e){if(!wijmo_1.asBoolean(e))throw"ODataVirtualCollectionView requires filterOnServer = true."},enumerable:!0,configurable:!0});Object.defineProperty(ODataVirtualCollectionView.prototype,"canGroup",{get:function(){return this._canGroup},set:function(e){if(wijmo_1.asBoolean(e))throw"ODataVirtualCollectionView does not support grouping."},enumerable:!0,configurable:!0});ODataVirtualCollectionView.prototype._performRefresh=function(){this.isLoading||(this._refresh=!0);e.prototype._performRefresh.call(this)};ODataVirtualCollectionView.prototype._getReadParams=function(t){var i=e.prototype._getReadParams.call(this,t);if(!t){i.$skip=this._skip||0;i.$top=this.pageSize}return i};ODataVirtualCollectionView.prototype._storeItems=function(e,t){if(this._refresh||this._data.length!=this.totalItemCount){this._data.length=this.totalItemCount;for(var i=0;i<this._data.length;i++)this._data[i]=new _NullValue(i);this._refresh=!1}if(!t){this.currentPosition<0&&this.moveCurrentToFirst();this._loadOffset=0}var o=this._loadOffset+(this._skip||0);for(i=0;i<e.length;i++)this._data[i+o]=e[i];this._loadOffset+=e.length};ODataVirtualCollectionView.prototype._performSetWindow=function(e,t){var i=this;if(this._pendingRequest){this._pendingRequest.abort();this._pendingRequest=null;this.onRequestCanceled()}e=wijmo_1.asInt(e);t=wijmo_1.asInt(t);wijmo_1.assert(t>=e,"Start must be smaller than end.");var o=wijmo_1.isNumber(this._start)&&e>this._start;this._start=e;this._end=t;for(var n=!1,r=e;r<t&&r<this._data.length&&!n;r++)n=this._data[r]instanceof _NullValue;if(n){var a=Math.max(0,o?e:t-this.pageSize);for(r=a;r<this._data.length&&!(this._data[r]instanceof _NullValue);r++)a++;this._skip=a;this._getData(null,(function(e){i._pendingRequest=e}))}};return ODataVirtualCollectionView}(ODataCollectionView);exports.ODataVirtualCollectionView=ODataVirtualCollectionView;var _NullValue=function _NullValue(e){this._id=e};wijmo_1._registerModule("wijmo.odata",selfModule);